<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Corretor de Redações ENEM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; }
        .highlighter-cursor.active { cursor: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiIgZmlsbD0iIzAwMDAwMCIgdmlld0JveD0iMCAwIDI1NiAyNTYiPjxwYXRoIGQ9Ik0yMjguODksODQuODlsLTU2LjItNTYuOUExNiwxNiwwLDAsMCwxNjAuMjIsMjRIMTRhOCw4LDAsMCwwLTgsOFYyMjRhOCw4LDAsMCwwLDgsOGg1MC4yMmExNiwxNiwwLDAsMCwxMS4zMS00LjY5bDEwOC43LTExMC45MUExNiwxNiwwLDAsMCwyMjguODksODQuODlaTTEwNCwxOTIuMjNhOCw4LDAsMCwxLTExLjMxLDExLjMxbC0xNiwxNkgzMlY0MGgxMjAuMjNsNDgsNDguNDVaTTIxNiwxMDQuODlsLTQwLTQwTDE5Miw0OC44OSwyMDgsNjQuODlaIj48L3BhdGg+PC9zdmc+'), crosshair; }
        .page-container { position: relative; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 1rem; background-color: white; }
        #essay-viewer { overflow: auto; -webkit-overflow-scrolling: touch; }
        #zoom-target { transform-origin: 0 0; }
        .annotation-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; }
        .tool-selector.active { transform: scale(1.15); box-shadow: 0 0 0 3px #3b82f6; }
        .score-button { padding: 0.3rem 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-weight: 500; transition: all 0.15s; background-color: #f9fafb; color: #374151; flex-grow: 1; }
        .score-button:hover { background-color: #f3f4f6; border-color: #9ca3af; }
        .score-button.selected-score { background-color: #2563eb; color: white; border-color: #1d4ed8; transform: scale(1.05); }
        select { appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236b7280' d='M6 8L1 3h10z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 0.75rem center; }
        .history-badge { display: inline-flex; align-items: center; gap: 4px; background: #eff6ff; color: #1e40af; font-size: 11px; padding: 2px 8px; border-radius: 999px; font-weight: 600; }
        .zoom-btn { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; background: white; border: 1px solid #d1d5db; border-radius: 8px; font-size: 18px; font-weight: bold; color: #374151; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .zoom-btn:active { background: #f3f4f6; }
        .drawer-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 70; opacity: 0; pointer-events: none; transition: opacity 0.25s; }
        .drawer-overlay.active { opacity: 1; pointer-events: auto; }
        .drawer { position: fixed; top: 0; left: 0; width: 320px; max-width: 85vw; height: 100vh; background: white; z-index: 71; transform: translateX(-100%); transition: transform 0.25s ease; overflow-y: auto; box-shadow: 4px 0 15px rgba(0,0,0,0.2); }
        .drawer.open { transform: translateX(0); }
        @media (max-width: 1023px) {
            #evaluation-panel { position: fixed; top: 0; right: 0; width: 260px; max-width: 75vw; height: 100vh; transform: translateX(100%); transition: transform 0.25s ease; z-index: 50; overflow-y: auto; box-shadow: -4px 0 15px rgba(0,0,0,0.2); }
            #evaluation-panel.is-open { transform: translateX(0); }
            #panel-overlay { position: fixed; inset: 0; background-color: rgba(0,0,0,0.5); z-index: 49; opacity: 0; transition: opacity 0.25s; pointer-events: none; }
            #panel-overlay.is-active { opacity: 1; pointer-events: auto; }
            #panel-toggle-button { position: fixed; top: 50%; right: 0; transform: translateY(-50%); z-index: 60; background-color: #2563eb; color: white; padding: 0.8rem 0.4rem; border-top-left-radius: 0.5rem; border-bottom-left-radius: 0.5rem; box-shadow: -2px 0 5px rgba(0,0,0,0.2); transition: right 0.25s; }
            #evaluation-panel.is-open + #panel-toggle-button { right: 260px; }
            @media (min-width: 260px) { #evaluation-panel.is-open + #panel-toggle-button { right: 260px; } }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- DRAWER: Dados do Aluno (escondido, abre por botao) -->
    <div id="drawer-overlay" class="drawer-overlay"></div>
    <div id="student-drawer" class="drawer">
        <div class="p-4">
            <div class="flex items-center justify-between mb-4 border-b pb-3">
                <h2 class="text-lg font-bold text-gray-800">Dados da Correcao</h2>
                <button id="drawer-close" class="p-1 rounded-full hover:bg-gray-200">
                    <svg class="w-6 h-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>

            <div class="space-y-4">
                <div>
                    <label for="student-select" class="block font-semibold mb-1 text-sm">Aluno:</label>
                    <select id="student-select" class="w-full p-2.5 border rounded-md focus:ring-2 focus:ring-blue-500 text-sm pr-8 bg-white">
                        <option value="">-- Selecione o aluno --</option>
                    </select>
                    <input type="hidden" id="student-email">
                </div>

                <div>
                    <label for="lesson-number" class="block font-semibold mb-1 text-sm">Numero da Aula:</label>
                    <input type="number" id="lesson-number" min="1" placeholder="Ex: 1, 2, 3..." class="w-full p-2.5 border rounded-md focus:ring-2 focus:ring-blue-500 text-sm">
                </div>

                <div>
                    <label for="lesson-theme" class="block font-semibold mb-1 text-sm">Tema da Redacao:</label>
                    <input type="text" id="lesson-theme" placeholder="Ex: Saude mental no Brasil" class="w-full p-2.5 border rounded-md focus:ring-2 focus:ring-blue-500 text-sm">
                </div>

                <div id="student-history-section" class="hidden">
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                        <div class="flex items-center justify-between mb-2">
                            <span class="font-semibold text-sm text-blue-800">Historico</span>
                            <span id="history-count" class="history-badge">0 redacoes</span>
                        </div>
                        <div id="history-list" class="text-xs space-y-1 max-h-40 overflow-y-auto"></div>
                        <div id="history-chart-container" class="mt-2 hidden">
                            <canvas id="history-mini-chart" height="120"></canvas>
                        </div>
                    </div>
                </div>

                <div>
                    <label for="folder-select" class="block font-semibold mb-1 text-sm">Salvar em:</label>
                    <div class="flex gap-1">
                        <select id="folder-select" class="flex-1 p-2.5 border rounded-md focus:ring-2 focus:ring-blue-500 text-sm pr-8 bg-white">
                            <option value="">Pasta do aluno (padrao)</option>
                        </select>
                        <button id="new-folder-btn" title="Criar nova pasta" class="px-3 border rounded-md hover:bg-gray-100 text-gray-600">
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                        </button>
                    </div>
                </div>

                <button id="drawer-confirm" class="w-full bg-blue-600 text-white font-semibold py-2.5 rounded-lg hover:bg-blue-700 mt-2">
                    Confirmar Dados
                </button>
            </div>
        </div>
    </div>

    <div class="container mx-auto p-2 md:p-4">
        <header id="page-header" class="text-center mb-3">
            <h1 class="text-xl md:text-2xl font-bold text-gray-900">Corretor Web App</h1>
            <p class="text-sm md:text-base font-semibold text-gray-700">PROFESSORA JAQUELINE CARDOSO</p>
            <p class="text-xs text-blue-600 mt-1" id="loading-status">Carregando dados...</p>
        </header>

        <div id="file-selector-bar" class="bg-white p-2 rounded-lg shadow-md mb-3 flex items-center justify-center gap-3">
            <label for="file-upload" class="cursor-pointer bg-blue-600 text-white font-semibold py-1.5 px-4 rounded-lg hover:bg-blue-700 transition-colors text-xs">
                Selecionar Arquivo (PDF ou Imagem)
            </label>
            <input id="file-upload" type="file" class="hidden" accept="image/*,application/pdf">
            <span id="file-name" class="text-gray-500 text-xs truncate max-w-xs">Nenhum arquivo</span>
        </div>

        <main id="main-content" class="grid grid-cols-1 lg:grid-cols-4 gap-3">
            <section id="essay-viewer" class="lg:col-span-3 bg-gray-200 rounded-lg overflow-auto min-h-[90vh] relative">
                 <div id="zoom-target">
                    <div id="drop-zone" class="flex flex-col items-center justify-center h-full border-2 border-dashed border-gray-400 rounded-lg text-center p-8 absolute inset-0">
                        <svg class="h-12 w-12 text-gray-500 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" /></svg>
                        <p class="text-gray-600 font-semibold">Arraste e solte o arquivo aqui</p>
                        <p class="text-gray-400 text-xs mt-1">PDF e imagens (JPG, PNG)</p>
                    </div>
                 </div>
            </section>

            <aside id="evaluation-panel" class="lg:col-span-1 bg-white p-3 rounded-lg shadow-lg hidden h-fit lg:sticky lg:top-4">
                <div class="flex justify-between items-center mb-2 border-b pb-2">
                    <h2 class="text-base font-bold">Avaliacao</h2>
                    <div class="flex gap-1">
                        <!-- Botao Dados do Aluno -->
                        <button id="open-drawer-btn" title="Dados do Aluno" class="p-1.5 rounded-full hover:bg-blue-100 transition-colors bg-blue-50">
                            <svg class="w-5 h-5 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                        </button>
                        <button id="new-correction-btn" title="Nova Correcao (F5)" class="p-1.5 rounded-full hover:bg-gray-200 transition-colors">
                            <svg class="w-5 h-5 text-gray-600" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/><path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/></svg>
                        </button>
                    </div>
                </div>

                <!-- Resumo do aluno selecionado (inline, compacto) -->
                <div id="student-summary" class="text-xs text-gray-500 mb-2 hidden">
                    <span id="summary-name" class="font-semibold text-gray-700"></span> — Aula <span id="summary-lesson" class="font-semibold text-gray-700"></span>
                </div>

                <div class="space-y-2">
                    <div class="competency border-t pt-2"><label class="block font-semibold text-sm">Competencia I</label><p class="text-xs text-gray-500 mb-1">Dominio da norma culta.</p><div class="flex flex-wrap gap-1 score-selector"><button data-score="0" class="score-button selected-score">0</button><button data-score="40" class="score-button">40</button><button data-score="80" class="score-button">80</button><button data-score="120" class="score-button">120</button><button data-score="160" class="score-button">160</button><button data-score="200" class="score-button">200</button></div><input type="hidden" class="competency-score" id="c1" value="0"></div>
                    <div class="competency"><label class="block font-semibold text-sm">Competencia II</label><p class="text-xs text-gray-500 mb-1">Compreensao da proposta.</p><div class="flex flex-wrap gap-1 score-selector"><button data-score="0" class="score-button selected-score">0</button><button data-score="40" class="score-button">40</button><button data-score="80" class="score-button">80</button><button data-score="120" class="score-button">120</button><button data-score="160" class="score-button">160</button><button data-score="200" class="score-button">200</button></div><input type="hidden" class="competency-score" id="c2" value="0"></div>
                    <div class="competency"><label class="block font-semibold text-sm">Competencia III</label><p class="text-xs text-gray-500 mb-1">Organizar informacoes.</p><div class="flex flex-wrap gap-1 score-selector"><button data-score="0" class="score-button selected-score">0</button><button data-score="40" class="score-button">40</button><button data-score="80" class="score-button">80</button><button data-score="120" class="score-button">120</button><button data-score="160" class="score-button">160</button><button data-score="200" class="score-button">200</button></div><input type="hidden" class="competency-score" id="c3" value="0"></div>
                    <div class="competency"><label class="block font-semibold text-sm">Competencia IV</label><p class="text-xs text-gray-500 mb-1">Mecanismos linguisticos.</p><div class="flex flex-wrap gap-1 score-selector"><button data-score="0" class="score-button selected-score">0</button><button data-score="40" class="score-button">40</button><button data-score="80" class="score-button">80</button><button data-score="120" class="score-button">120</button><button data-score="160" class="score-button">160</button><button data-score="200" class="score-button">200</button></div><input type="hidden" class="competency-score" id="c4" value="0"></div>
                    <div class="competency"><label class="block font-semibold text-sm">Competencia V</label><p class="text-xs text-gray-500 mb-1">Proposta de intervencao.</p><div class="flex flex-wrap gap-1 score-selector"><button data-score="0" class="score-button selected-score">0</button><button data-score="40" class="score-button">40</button><button data-score="80" class="score-button">80</button><button data-score="120" class="score-button">120</button><button data-score="160" class="score-button">160</button><button data-score="200" class="score-button">200</button></div><input type="hidden" class="competency-score" id="c5" value="0"></div>

                    <div class="pt-2 border-t"><h3 class="text-lg font-bold">Nota Final: <span id="final-score" class="text-blue-600">0</span></h3></div>

                    <button id="save-finalize-btn" class="w-full bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700 disabled:bg-gray-400 shadow-md" disabled>
                        FINALIZAR E ENVIAR
                    </button>
                    <p class="text-center text-xs text-gray-400 pt-1">PROJETO JOHNNY v2.0</p>
                </div>
            </aside>
        </main>
    </div>

    <!-- Barra inferior: marcadores + zoom -->
    <div id="highlighter-toolbar" class="hidden fixed bottom-4 left-1/2 -translate-x-1/2 z-40 bg-white p-2 rounded-full shadow-lg flex flex-row items-center gap-2">
        <button id="cursor-tool" class="tool-selector p-1.5 rounded-full border-2 border-gray-200 transition-transform active" data-tool="cursor" title="Navegar"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M6.6,15.5l-3.2,2.1c-0.2,0.1-0.5,0.1-0.7-0.1l-1.4-1.4c-0.2-0.2-0.2-0.5,0-0.7l2.1-3.2L15.5,0.6c0.2-0.2,0.5-0.2,0.7,0l3.2,3.2c0.2,0.2,0.2,0.5,0,0.7L6.6,15.5z M4.7,13.1l-0.7,1.1l0.7,0.7l1.1-0.7L4.7,13.1z"/></svg></button>
        <button class="tool-selector w-6 h-6 rounded-full border-2 border-gray-200 transition-transform" data-color="rgba(255, 255, 0, 0.4)" style="background-color: yellow;" title="Amarelo"></button>
        <button class="tool-selector w-6 h-6 rounded-full border-2 border-gray-200 transition-transform" data-color="rgba(0, 255, 255, 0.4)" style="background-color: cyan;" title="Ciano"></button>
        <button class="tool-selector w-6 h-6 rounded-full border-2 border-gray-200 transition-transform" data-color="rgba(255, 0, 255, 0.4)" style="background-color: magenta;" title="Magenta"></button>
        <button id="clear-annotations" class="tool-selector p-1.5 rounded-full border-2 border-gray-200 transition-transform" title="Limpar"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg></button>
        <div class="border-l h-5 mx-1"></div>
        <button id="zoom-out-btn" class="zoom-btn" title="Diminuir">−</button>
        <span id="zoom-level" class="text-xs font-semibold text-gray-600 w-10 text-center">100%</span>
        <button id="zoom-in-btn" class="zoom-btn" title="Aumentar">+</button>
        <button id="zoom-reset-btn" class="zoom-btn text-xs" title="Resetar">1:1</button>
    </div>

    <button id="panel-toggle-button" class="lg:hidden hidden"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button>
    <div id="panel-overlay" class="lg:hidden"></div>
    <div id="alert-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-[80] p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-md w-full">
            <h3 id="alert-title" class="text-xl font-bold mb-4 text-center">Atencao</h3>
            <div id="alert-content" class="text-gray-700 mb-6 text-left text-sm whitespace-pre-wrap max-h-[60vh] overflow-y-auto"></div>
            <div class="flex justify-center"><button id="alert-close" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700">OK</button></div>
        </div>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js';

        const els = {
            fileUpload: document.getElementById('file-upload'),
            fileNameSpan: document.getElementById('file-name'),
            essayViewer: document.getElementById('essay-viewer'),
            zoomTarget: document.getElementById('zoom-target'),
            dropZone: document.getElementById('drop-zone'),
            evaluationPanel: document.getElementById('evaluation-panel'),
            saveFinalizeBtn: document.getElementById('save-finalize-btn'),
            clearAnnotationsBtn: document.getElementById('clear-annotations'),
            panelToggleButton: document.getElementById('panel-toggle-button'),
            panelOverlay: document.getElementById('panel-overlay'),
            highlighterToolbar: document.getElementById('highlighter-toolbar'),
            studentSelect: document.getElementById('student-select'),
            studentEmailInput: document.getElementById('student-email'),
            lessonNumber: document.getElementById('lesson-number'),
            lessonTheme: document.getElementById('lesson-theme'),
            folderSelect: document.getElementById('folder-select'),
            newFolderBtn: document.getElementById('new-folder-btn'),
            newCorrectionBtn: document.getElementById('new-correction-btn'),
            pageHeader: document.getElementById('page-header'),
            fileSelectorBar: document.getElementById('file-selector-bar'),
            alertModal: document.getElementById('alert-modal'),
            alertTitle: document.getElementById('alert-title'),
            alertContent: document.getElementById('alert-content'),
            alertClose: document.getElementById('alert-close'),
            loadingStatus: document.getElementById('loading-status'),
            historySection: document.getElementById('student-history-section'),
            historyCount: document.getElementById('history-count'),
            historyList: document.getElementById('history-list'),
            historyChartContainer: document.getElementById('history-chart-container'),
            drawer: document.getElementById('student-drawer'),
            drawerOverlay: document.getElementById('drawer-overlay'),
            drawerClose: document.getElementById('drawer-close'),
            drawerConfirm: document.getElementById('drawer-confirm'),
            openDrawerBtn: document.getElementById('open-drawer-btn'),
            studentSummary: document.getElementById('student-summary'),
            summaryName: document.getElementById('summary-name'),
            summaryLesson: document.getElementById('summary-lesson'),
            zoomInBtn: document.getElementById('zoom-in-btn'),
            zoomOutBtn: document.getElementById('zoom-out-btn'),
            zoomResetBtn: document.getElementById('zoom-reset-btn'),
            zoomLevel: document.getElementById('zoom-level')
        };

        // Estado
        let studentsList = [];
        let foldersList = [];
        let currentHistory = [];
        let miniChart = null;
        let activeColor = 'rgba(255, 255, 0, 0.4)';
        let highlighterEnabled = false;
        let scale = 1;
        let fileLoaded = false;

        // --- DRAWER (Menu escondido) ---
        function openDrawer() { els.drawer.classList.add('open'); els.drawerOverlay.classList.add('active'); }
        function closeDrawer() { els.drawer.classList.remove('open'); els.drawerOverlay.classList.remove('active'); }
        els.openDrawerBtn.addEventListener('click', openDrawer);
        els.drawerClose.addEventListener('click', closeDrawer);
        els.drawerOverlay.addEventListener('click', closeDrawer);
        els.drawerConfirm.addEventListener('click', function() {
            updateStudentSummary();
            closeDrawer();
        });

        function updateStudentSummary() {
            const idx = els.studentSelect.value;
            const lesson = els.lessonNumber.value;
            if (idx !== '' && lesson) {
                els.summaryName.textContent = studentsList[idx].name;
                els.summaryLesson.textContent = lesson;
                els.studentSummary.classList.remove('hidden');
            }
        }

        // --- Inicializacao ---
        window.onload = function() {
            let loadedCount = 0;
            function checkAllLoaded() {
                loadedCount++;
                if (loadedCount >= 2) {
                    els.loadingStatus.textContent = 'Pronto!';
                    setTimeout(() => els.loadingStatus.style.display = 'none', 1000);
                }
            }

            google.script.run
                .withSuccessHandler(function(data) {
                    studentsList = data;
                    populateStudentDropdown();
                    checkAllLoaded();
                })
                .withFailureHandler(function() {
                    showAlert('Erro', 'Nao foi possivel carregar alunos.\nVerifique a aba DADOS.');
                    checkAllLoaded();
                })
                .getStudentsFromSheet();

            google.script.run
                .withSuccessHandler(function(data) { foldersList = data; populateFolderDropdown(); checkAllLoaded(); })
                .withFailureHandler(function() { checkAllLoaded(); })
                .getDriveFolders();
        };

        // --- Dropdown Alunos ---
        function populateStudentDropdown() {
            els.studentSelect.innerHTML = '<option value="">-- Selecione o aluno --</option>';
            studentsList.forEach((s, i) => {
                const opt = document.createElement('option');
                opt.value = i; opt.textContent = s.name;
                els.studentSelect.appendChild(opt);
            });
        }

        els.studentSelect.addEventListener('change', function() {
            const idx = this.value;
            if (idx === '') { els.studentEmailInput.value = ''; els.historySection.classList.add('hidden'); return; }
            els.studentEmailInput.value = studentsList[idx].email;
            google.script.run
                .withSuccessHandler(function(h) { currentHistory = h; displayStudentHistory(h); })
                .withFailureHandler(function() {})
                .getStudentHistory(studentsList[idx].name);
        });

        function displayStudentHistory(history) {
            if (history.length === 0) {
                els.historySection.classList.remove('hidden');
                els.historyCount.textContent = 'Nenhuma';
                els.historyList.innerHTML = '<p class="text-gray-500 italic">Primeira correcao.</p>';
                els.historyChartContainer.classList.add('hidden');
                return;
            }
            els.historySection.classList.remove('hidden');
            els.historyCount.textContent = history.length + (history.length > 1 ? ' redacoes' : ' redacao');
            let html = '';
            history.forEach(h => {
                const color = h.total >= 800 ? 'text-green-700' : h.total >= 500 ? 'text-yellow-700' : 'text-red-700';
                html += '<div class="flex justify-between py-1 border-b border-blue-100"><span>Aula ' + h.lessonNumber + ' <span class="text-gray-400">(' + h.date + ')</span></span><span class="font-bold ' + color + '">' + h.total + '</span></div>';
            });
            els.historyList.innerHTML = html;
            if (history.length >= 2) { els.historyChartContainer.classList.remove('hidden'); renderMiniChart(history); }
            else { els.historyChartContainer.classList.add('hidden'); }
        }

        function renderMiniChart(history) {
            const ctx = document.getElementById('history-mini-chart').getContext('2d');
            if (miniChart) miniChart.destroy();
            miniChart = new Chart(ctx, {
                type: 'line',
                data: { labels: history.map(h => 'Aula ' + h.lessonNumber), datasets: [{ data: history.map(h => h.total), borderColor: '#1e40af', backgroundColor: 'rgba(30,64,175,0.1)', fill: true, tension: 0.3, pointRadius: 4, pointBackgroundColor: '#1e40af' }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { min: 0, max: 1000, ticks: { stepSize: 200, font: { size: 9 } } }, x: { ticks: { font: { size: 9 } } } } }
            });
        }

        // --- Dropdown Pastas ---
        function populateFolderDropdown() {
            els.folderSelect.innerHTML = '<option value="">Pasta do aluno (padrao)</option>';
            foldersList.forEach(f => { const o = document.createElement('option'); o.value = f.id; o.textContent = f.name; els.folderSelect.appendChild(o); });
        }

        els.newFolderBtn.addEventListener('click', function() {
            const name = prompt('Nome da nova pasta:');
            if (!name || !name.trim()) return;
            google.script.run
                .withSuccessHandler(function(f) { foldersList.push(f); populateFolderDropdown(); els.folderSelect.value = f.id; })
                .withFailureHandler(function() { showAlert('Erro', 'Nao foi possivel criar a pasta.'); })
                .createNewFolder(name.trim());
        });

        els.newCorrectionBtn.addEventListener('click', () => location.reload());

        // --- Upload ---
        els.essayViewer.addEventListener('dragover', (e) => e.preventDefault());
        els.essayViewer.addEventListener('drop', (e) => { e.preventDefault(); if (e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]); });
        els.fileUpload.addEventListener('change', (e) => { if (e.target.files[0]) handleFile(e.target.files[0]); });

        async function handleFile(file) {
            els.fileNameSpan.textContent = file.name;
            els.pageHeader.classList.add('hidden');
            els.fileSelectorBar.classList.add('hidden');
            els.zoomTarget.innerHTML = '<p class="text-center p-8 text-gray-500">Carregando...</p>';
            els.evaluationPanel.classList.remove('hidden');
            els.panelToggleButton.classList.remove('hidden');
            els.highlighterToolbar.classList.remove('hidden');
            els.saveFinalizeBtn.disabled = false;
            fileLoaded = true;
            closeMobilePanel();
            scale = 1; updateZoom();

            if (file.type === 'application/pdf') await renderPdf(file);
            else if (file.type.startsWith('image/')) await renderImageAsCanvas(file);
            else els.zoomTarget.innerHTML = '<p class="text-center p-8 text-red-500">Formato nao suportado.</p>';

            // Abrir drawer automaticamente para preencher dados
            openDrawer();
        }

        function renderImageAsCanvas(file) {
            return new Promise(resolve => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        els.zoomTarget.innerHTML = '';
                        const container = createPageContainer();
                        const canvas = document.createElement('canvas');
                        canvas.className = 'page-content';
                        const maxW = 900;
                        let w = img.naturalWidth, h = img.naturalHeight;
                        if (w > maxW) { h = Math.round(h * (maxW / w)); w = maxW; }
                        canvas.width = w; canvas.height = h;
                        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                        container.appendChild(canvas);
                        els.zoomTarget.appendChild(container);
                        setupAnnotationCanvas(container, w, h);
                        resolve();
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        async function renderPdf(file) {
            els.zoomTarget.innerHTML = '';
            return new Promise(resolve => {
                const fr = new FileReader();
                fr.onload = async function() {
                    const pdf = await pdfjsLib.getDocument(new Uint8Array(this.result)).promise;
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const vp = page.getViewport({ scale: 1.5 });
                        const container = createPageContainer();
                        const canvas = document.createElement('canvas');
                        canvas.className = 'page-content';
                        canvas.width = vp.width; canvas.height = vp.height;
                        await page.render({ canvasContext: canvas.getContext('2d'), viewport: vp }).promise;
                        container.appendChild(canvas);
                        els.zoomTarget.appendChild(container);
                        setupAnnotationCanvas(container, vp.width, vp.height);
                    }
                    resolve();
                };
                fr.readAsArrayBuffer(file);
            });
        }

        function createPageContainer() { const c = document.createElement('div'); c.className = 'page-container'; return c; }

        // --- ZOOM POR BOTOES ---
        function updateZoom() {
            els.zoomTarget.style.transform = 'scale(' + scale + ')';
            els.zoomLevel.textContent = Math.round(scale * 100) + '%';
        }
        els.zoomInBtn.addEventListener('click', () => { scale = Math.min(3, scale + 0.25); updateZoom(); });
        els.zoomOutBtn.addEventListener('click', () => { scale = Math.max(0.5, scale - 0.25); updateZoom(); });
        els.zoomResetBtn.addEventListener('click', () => { scale = 1; updateZoom(); });

        // --- Anotacoes ---
        function setupAnnotationCanvas(container, width, height) {
            const ac = document.createElement('canvas');
            ac.className = 'annotation-canvas';
            ac.width = width; ac.height = height;
            container.appendChild(ac);
            const ctx = ac.getContext('2d');
            ctx.lineJoin = 'round'; ctx.lineCap = 'butt'; ctx.lineWidth = 15;
            let firstPoint = null;

            const getPoint = (e) => {
                const cx = e.clientX || (e.changedTouches && e.changedTouches[0].clientX);
                const cy = e.clientY || (e.changedTouches && e.changedTouches[0].clientY);
                const r = ac.getBoundingClientRect();
                return { x: (cx - r.left) / (r.width / ac.width), y: (cy - r.top) / (r.height / ac.height) };
            };

            const onHighlight = (e) => {
                if (!highlighterEnabled) return;
                const pt = getPoint(e);
                if (!firstPoint) { firstPoint = pt; }
                else { ctx.strokeStyle = activeColor; ctx.beginPath(); ctx.moveTo(firstPoint.x, firstPoint.y); ctx.lineTo(pt.x, firstPoint.y); ctx.stroke(); firstPoint = null; }
            };

            ac.addEventListener('click', onHighlight);
            ac.addEventListener('touchend', (e) => { if (highlighterEnabled) { e.preventDefault(); onHighlight(e); } }, { passive: false });
            ac.addEventListener('resetHighlightState', () => { firstPoint = null; });
        }

        const toolSelectors = document.querySelectorAll('.tool-selector');
        toolSelectors.forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.annotation-canvas').forEach(c => c.dispatchEvent(new Event('resetHighlightState')));
                toolSelectors.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                if (btn.dataset.color) { activeColor = btn.dataset.color; highlighterEnabled = true; els.essayViewer.classList.add('highlighter-cursor', 'active'); }
                else { highlighterEnabled = false; els.essayViewer.classList.remove('highlighter-cursor', 'active'); }
            });
        });
        els.clearAnnotationsBtn.addEventListener('click', () => {
            document.querySelectorAll('.annotation-canvas').forEach(c => c.getContext('2d').clearRect(0, 0, c.width, c.height));
        });

        // --- Notas ---
        const finalScoreSpan = document.getElementById('final-score');
        document.querySelectorAll('.score-selector').forEach(container => {
            container.addEventListener('click', (e) => {
                if (!e.target.classList.contains('score-button')) return;
                e.target.parentElement.nextElementSibling.value = e.target.dataset.score;
                container.querySelectorAll('.score-button').forEach(s => s.classList.remove('selected-score'));
                e.target.classList.add('selected-score');
                let t = 0; document.querySelectorAll('.competency-score').forEach(i => t += Number(i.value) || 0);
                finalScoreSpan.textContent = t;
            });
        });

        // --- UI Helpers ---
        function showAlert(title, content) { els.alertTitle.textContent = title; els.alertContent.innerHTML = content; els.alertModal.classList.remove('hidden'); }
        els.alertClose.addEventListener('click', () => els.alertModal.classList.add('hidden'));
        function closeMobilePanel() { els.evaluationPanel.classList.remove('is-open'); els.panelOverlay.classList.remove('is-active'); }
        els.panelToggleButton.addEventListener('click', () => { const o = els.evaluationPanel.classList.toggle('is-open'); els.panelOverlay.classList.toggle('is-active', o); });
        els.panelOverlay.addEventListener('click', closeMobilePanel);
        document.addEventListener('keydown', (e) => { if (e.key === 'F5') { e.preventDefault(); location.reload(); } });

        // --- SALVAR E ENVIAR (otimizado: captura direto dos canvas, sem html2canvas) ---
        els.saveFinalizeBtn.addEventListener('click', async () => {
            const studentIdx = els.studentSelect.value;
            if (studentIdx === '') { showAlert('Atencao', 'Abra os Dados da Correcao e selecione um aluno.'); openDrawer(); return; }
            const student = studentsList[studentIdx];
            const lessonNum = els.lessonNumber.value.trim();
            const theme = els.lessonTheme.value.trim();
            if (!lessonNum) { showAlert('Atencao', 'Informe o numero da aula.'); openDrawer(); return; }
            if (!theme) { showAlert('Atencao', 'Informe o tema da redacao.'); openDrawer(); return; }

            const scores = {
                c1: Number(document.getElementById('c1').value) || 0,
                c2: Number(document.getElementById('c2').value) || 0,
                c3: Number(document.getElementById('c3').value) || 0,
                c4: Number(document.getElementById('c4').value) || 0,
                c5: Number(document.getElementById('c5').value) || 0,
                total: Number(finalScoreSpan.textContent) || 0
            };
            const folderId = els.folderSelect.value || '';

            els.highlighterToolbar.style.display = 'none';
            els.saveFinalizeBtn.disabled = true;
            els.saveFinalizeBtn.textContent = 'Gerando PDF...';

            await new Promise(r => setTimeout(r, 50));

            // Captura RAPIDA: extrair canvases diretamente (sem html2canvas)
            const containers = document.querySelectorAll('.page-container');
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({ orientation: 'p', unit: 'px', format: 'a4' });
            const pageW = pdf.internal.pageSize.getWidth();
            const pageH = pdf.internal.pageSize.getHeight();
            let isFirstPage = true;

            containers.forEach(container => {
                const pageCanvas = container.querySelector('.page-content');
                const annotCanvas = container.querySelector('.annotation-canvas');
                if (!pageCanvas) return;

                // Mesclar page + anotacoes em um canvas temporario
                const merged = document.createElement('canvas');
                merged.width = pageCanvas.width;
                merged.height = pageCanvas.height;
                const mCtx = merged.getContext('2d');
                mCtx.drawImage(pageCanvas, 0, 0);
                if (annotCanvas) mCtx.drawImage(annotCanvas, 0, 0);

                const imgData = merged.toDataURL('image/jpeg', 0.85);
                const imgH = (merged.height * pageW) / merged.width;

                if (!isFirstPage) pdf.addPage();
                isFirstPage = false;

                // Se a imagem cabe na pagina, adicionar direto
                if (imgH <= pageH) {
                    pdf.addImage(imgData, 'JPEG', 0, 0, pageW, imgH);
                } else {
                    // Imagem maior que uma pagina: dividir
                    let yOffset = 0;
                    while (yOffset < imgH) {
                        if (yOffset > 0) pdf.addPage();
                        pdf.addImage(imgData, 'JPEG', 0, -yOffset, pageW, imgH);
                        yOffset += pageH;
                    }
                }
            });

            const pdfOutput = pdf.output('datauristring');

            els.saveFinalizeBtn.textContent = 'Enviando...';

            google.script.run
                .withSuccessHandler(function(res) {
                    els.highlighterToolbar.style.display = 'flex';
                    els.saveFinalizeBtn.disabled = false;
                    els.saveFinalizeBtn.textContent = 'FINALIZAR E ENVIAR';
                    if (res.success) {
                        let msg = '<strong>Salvo com sucesso!</strong><br><a href="' + res.url + '" target="_blank" class="text-blue-600 underline">Abrir no Drive</a><br><br>' + res.emailStatus + '<br>' + res.historyMessage;
                        showAlert('Sucesso!', msg);
                        if (studentIdx !== '') {
                            google.script.run.withSuccessHandler(function(h) { currentHistory = h; displayStudentHistory(h); }).getStudentHistory(student.name);
                        }
                    } else {
                        showAlert('Erro', 'Erro no servidor:<br>' + res.error);
                    }
                })
                .withFailureHandler(function() {
                    els.highlighterToolbar.style.display = 'flex';
                    els.saveFinalizeBtn.disabled = false;
                    els.saveFinalizeBtn.textContent = 'FINALIZAR E ENVIAR';
                    showAlert('Erro', 'Falha na comunicacao com o servidor.');
                })
                .processCorrection(pdfOutput, student.name, els.studentEmailInput.value.trim(), Number(lessonNum), theme, scores, folderId);
        });

    </script>
</body>
</html>
